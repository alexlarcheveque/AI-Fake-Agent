# Lead Follow-Up System

This system provides automated follow-up messages for leads based on their status. If a lead hasn't responded to a previous message, the system will send a follow-up using the same AI-generated messaging style.

## Follow-Up Frequency by Lead Status

The system sends follow-up messages based on the lead's status:

| Lead Status | Follow-Up Frequency |
|-------------|---------------------|
| New         | Weekly (7 days)     |
| Contacted   | Weekly (7 days)     |
| Qualified   | Weekly (7 days)     |
| Lost        | Monthly (30 days)   |

## How It Works

1. **Initial Contact**: When a lead is created, a scheduled message is set based on the `firstMessageTiming` preference (immediate, next day, one week, or two weeks).

2. **Follow-Up Scheduling**: After each sent message, the system automatically schedules the next follow-up based on the lead's current status.

3. **Message Generation**: Follow-up messages are generated by the AI assistant with contextual awareness of:
   - Lead's status
   - Number of previous messages sent
   - Time since last message
   - The same tone and style as previous messages

4. **Automatic Sending**: The system automatically sends scheduled messages when they are due.

5. **Timing Control**: Follow-ups are only sent if the lead hasn't responded to previous messages.

## Technical Implementation

The follow-up system is implemented in the `scheduledMessageService.js` file and runs on a scheduled basis:

1. A cron job checks for scheduled messages every hour
2. The `checkAndSendScheduledMessages()` method sends any due messages
3. The `scheduleNextMessage()` method schedules the next follow-up based on lead status
4. The `STATUS_FOLLOW_UP_INTERVALS` object defines the intervals for each status

## Disabling Follow-Ups

Follow-ups can be disabled for individual leads by setting the `enableFollowUps` field to `false` in the Lead record.

## Fixing Scheduling Issues

If you notice a lead with an incorrect next scheduled message date (e.g., scheduled too far in the future), you can fix it using one of these methods:

### 1. Using the API Endpoint

Send a POST request to `/api/leads/fix-scheduling/:id` where `:id` is the lead ID.

Example:
```bash
curl -X POST http://localhost:3000/api/leads/fix-scheduling/123
```

### 2. Using the Command-Line Utility

Run the fix-lead-schedules.js script from the backend directory:

To fix a specific lead:
```bash
node utils/fix-lead-schedules.js 123
```

To fix all leads with scheduled messages:
```bash
node utils/fix-lead-schedules.js
```

This will recalculate the next scheduled message date based on:
1. The lead's current status
2. The appropriate interval (7 days for New/Contacted/Qualified, 30 days for Lost)
3. The lead's last message date 